<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Detail | Inventory Portal</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .section-title { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #2563eb; display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #64748b; margin-bottom: 0.5rem; }
        .form-input { width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 0.9375rem; transition: all 0.2s; outline: none; }
        .form-input:focus { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.2); }
        .mode-detail .form-input { border-color: transparent !important; background: transparent !important; padding-left: 0 !important; color: #1e293b !important; pointer-events: none; font-weight: 600; appearance: none; }
        .mode-detail .form-input::placeholder { color: transparent !important; }
        .mode-detail .required-star, .mode-detail .hint, .mode-detail .select-arrow { display: none; }
        .mode-detail select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none !important; }
        .mode-detail textarea.form-input { resize: none; padding-top: 0 !important; }
    </style>
</head>
<body class="mode-create" id="pageBody">

    <div class="flex min-h-screen">
        <aside class="w-64 bg-white border-r border-gray-200 hidden lg:flex flex-col fixed h-full">
            <div class="p-8"><span class="font-bold text-xl text-blue-600">Asset Inventory</span></div>
            <nav class="flex-1 px-4 space-y-1">
                <a href="index.html" class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 rounded-lg transition-all">
                    <i class="fas fa-list"></i> Assets List
                </a>
            </nav>
        </aside>

        <main class="flex-1 lg:ml-64 flex flex-col">
            <header class="bg-white border-b border-gray-200 sticky top-0 z-30 px-8 py-4 flex justify-between items-center">
                <div>
                    <h1 id="navTitle" class="text-xl font-bold text-slate-800 tracking-tight">Create New Asset</h1>
                    <div class="text-xs text-slate-400 mt-1">
                        Home / Assets / <span id="breadcrumbCurrent" class="text-slate-600 font-medium">New Asset</span>
                    </div>
                </div>

                <div id="actionBar" class="hidden flex items-center gap-3">
                    <button onclick="setMode('edit', document.getElementById('assetName').value)" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 shadow-md">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                    <button onclick="confirmDelete()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-100 transition-all">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </header>

            <div class="p-8 max-w-5xl">
                <form id="assetForm" class="space-y-12">
                    
                    <section>
                        <div class="section-title">01 Identification</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="form-group lg:col-span-2">
                                <label>Asset Name <span class="text-red-500 required-star">*</span></label>
                                <input type="text" id="assetName" required class="form-input" placeholder="e.g. Dell Latitude 5540">
                            </div>
                            <div class="form-group">
                                <label>Category <span class="text-red-500 required-star">*</span></label>
                                <select id="category" required class="form-input" onchange="toggleCapacityFields(this.value)">
                                    <option value="">Select Category</option>
                                    <option value="Workstation">Workstation</option>
                                    <option value="Applications">Applications</option>
                                    <option value="Server">Server</option>
                                    <option value="Network">Network Device</option>
                                    <option value="Storage">Storage</option>
                                    <option value="Software">Software</option>
                                    <option value="Connectivity">Internet Connectivity</option>
                                    <option value="Printer">Printer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Serial Number</label>
                                <input type="text" id="serialNo" class="form-input" placeholder="SN-XXXX-XXXX">
                            </div>
                            <div class="form-group">
                                <label>Brand</label>
                                <input type="text" id="brand" class="form-input" placeholder="e.g. Dell">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" id="model" class="form-input" placeholder="e.g. Latitude">
                            </div>
                        </div>
                    </section>

                    <section>
                        <div class="section-title">02 Assignment</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="form-group"><label>Staff Name</label><input type="text" id="staffName" class="form-input"></div>
                            <div class="form-group"><label>Staff ID</label><input type="text" id="staffId" class="form-input"></div>
                            <div class="form-group">
                                <label>Department</label>
                                <select id="department" class="form-input">
                                    <option value="IT">IT</option>
                                    <option value="HR">HR</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Operations">Operations</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Location</label><input type="text" id="location" class="form-input"></div>
                        </div>
                    </section>

                    <section>
                        <div class="section-title">03 Technical Specs</div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="form-group"><label>IP Address</label><input type="text" id="ipAddress" class="form-input" placeholder="0.0.0.0"></div>
                            <div class="form-group"><label>OS</label><input type="text" id="os" class="form-input" placeholder="e.g. Windows 11"></div>
                            <div class="form-group"><label>OS Version</label><input type="text" id="osVersion" class="form-input" placeholder="e.g. 23H2"></div>
                        </div>
                    </section>

                    <section id="capacitySection" class="hidden">
                        <div class="section-title">04 Capacity & Performance</div>
                        <div id="memoryGroup" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="form-group">
                                <label>Memory Size</label>
                                <input type="text" id="memSize" class="form-input" placeholder="e.g. 32GB">
                            </div>
                            <div class="form-group"><label>Memory Used</label><input type="text" id="memUsed" class="form-input" placeholder="e.g. 8GB"></div>
                            <div class="form-group"><label>Memory Available</label><input type="text" id="memAvail" class="form-input" placeholder="e.g. 24GB"></div>
                        </div>

                        <div id="bandwidthGroup" class="hidden">
                            <div class="form-group max-w-xs">
                                <label>Bandwidth</label>
                                <input type="text" id="bandwidth" class="form-input" placeholder="e.g. 100Mbps">
                            </div>
                        </div>
                    </section>

                    <section>
                        <div class="section-title">05 Description & Security</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group"><label>Description</label><textarea id="description" rows="4" class="form-input"></textarea></div>
                            <div class="form-group"><label>Functionality</label><textarea id="functionality" rows="3" class="form-input"></textarea></div>
                            <div class="form-group">
                                <label>Sensitivity</label>
                                <select id="sensitivity" class="form-input">
                                    <option>Public</option><option>Internal</option><option>Confidential</option><option>Restricted</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Backup Location</label><input type="text" id="backupLoc" class="form-input"></div>
                        </div>
                    </section>

                    <div id="formControls" class="pt-6 space-y-3">
                        <button type="submit" id="primaryBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all">
                            Create Asset
                        </button>
                        <button type="button" onclick="cancelMode()" class="w-full text-slate-400 py-3 font-semibold hover:text-slate-600 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const assetId = urlParams.get('id');
        const requestedMode = urlParams.get('mode');
        const token = localStorage.getItem('token');
        let currentMode = 'create';
        let isDirty = false;

        window.onload = async () => {
            if (assetId) {
                document.getElementById('navTitle').innerText = "Loading Asset...";
                await loadAssetDetail(assetId);
                if (requestedMode === 'edit') {
                    setMode('edit', document.getElementById('assetName').value);
                }
            } else {
                setMode('create');
            }
        };

        async function loadAssetDetail(id) {
            try {
                const response = await fetch('http://172.28.192.16/asset/api/list_assets', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.status === 'success') {
                    const data = result.data.find(a => String(a.id) === String(id));
                    if (!data) return alert("Asset not found");

                    document.getElementById('assetName').value = data.Name || '';
                    document.getElementById('category').value = data.Category || '';
                    document.getElementById('serialNo').value = data.SerialNo || '';
                    document.getElementById('brand').value = data.Brand || '';
                    document.getElementById('model').value = data.Model || '';
                    document.getElementById('staffName').value = data.StaffName || '';
                    document.getElementById('staffId').value = data.StaffID || '';
                    document.getElementById('department').value = data.Department || '';
                    document.getElementById('location').value = data.Location || '';
                    document.getElementById('ipAddress').value = data.IP_Address || '';
                    document.getElementById('os').value = data.OS || '';
                    document.getElementById('osVersion').value = data.OS_Version || '';
                    document.getElementById('description').value = data.Description || '';
                    document.getElementById('functionality').value = data.Functionality || '';
                    document.getElementById('sensitivity').value = data.Sensitivity || '';
                    document.getElementById('backupLoc').value = data.Backup_Location || '';

                    // WITH THESE LINES:
                    document.getElementById('memSize').value = data.Memory_Size || '';
                    document.getElementById('bandwidth').value = data.Bandwidth || '';

                    // Used and Available are now direct strings
                    document.getElementById('memUsed').value = data.Memory_Used || '';
                    document.getElementById('memAvail').value = data.Memory_Available || '';

                    toggleCapacityFields(data.Category);
                    setMode('detail', data.Name);
                }
            } catch (err) {
                console.error("Error:", err);
            }
        }

        function toggleCapacityFields(category) {
            const section = document.getElementById('capacitySection');
            const memGroup = document.getElementById('memoryGroup');
            const bandGroup = document.getElementById('bandwidthGroup');
            section.classList.add('hidden');
            memGroup.classList.add('hidden');
            bandGroup.classList.add('hidden');

            if (['Workstation', 'Server', 'Storage'].includes(category)) {
                section.classList.remove('hidden');
                memGroup.classList.remove('hidden');
            } else if (category === 'Connectivity') {
                section.classList.remove('hidden');
                bandGroup.classList.remove('hidden');
            }
        }

        function setMode(mode, assetName = "") {
            currentMode = mode;
            isDirty = false;
            const body = document.getElementById('pageBody');
            const actionBar = document.getElementById('actionBar');
            const formControls = document.getElementById('formControls');
            const breadcrumb = document.getElementById('breadcrumbCurrent');
            
            body.className = `mode-${mode}`;

            if (mode === 'detail') {
                document.getElementById('navTitle').innerText = `Asset: ${assetName}`;
                breadcrumb.innerText = "Detail View";
                actionBar.classList.remove('hidden');
                formControls.classList.add('hidden');
            } else {
                document.getElementById('navTitle').innerText = mode === 'create' ? "Create New Asset" : "Edit Asset";
                breadcrumb.innerText = mode === 'create' ? "New Asset" : "Edit Mode";
                actionBar.classList.add('hidden');
                formControls.classList.remove('hidden');
                document.getElementById('primaryBtn').innerText = mode === 'create' ? "Create Asset" : "Save Changes";
            }
        }

        document.getElementById('assetForm').addEventListener('input', () => isDirty = true);

        window.onbeforeunload = () => isDirty ? "Unsaved changes!" : null;

        function cancelMode() {
            if (isDirty && !confirm("Discard changes?")) return;
            if (assetId && currentMode === 'edit') {
                setMode('detail', document.getElementById('assetName').value);
            } else {
                isDirty = false;
                window.location.href = 'index.html';
            }
        }

        document.getElementById('assetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('primaryBtn');
            const originalText = submitBtn.innerHTML;

            // Combine inputs into single strings for storage            
            const memStr = document.getElementById('memSize').value || "";
            const bandStr = document.getElementById('bandwidth').value || "";

            const baseData = {
                "Name": document.getElementById('assetName').value,
                "Category": document.getElementById('category').value,
                "SerialNo": document.getElementById('serialNo').value || "",
                "Brand": document.getElementById('brand').value || "",
                "Model": document.getElementById('model').value || "",
                "StaffName": document.getElementById('staffName').value || "",
                "StaffID": parseInt(document.getElementById('staffId').value) || 0,
                "Department": document.getElementById('department').value || "IT",
                "Location": document.getElementById('location').value || "",
                "IP_Address": document.getElementById('ipAddress').value || "",
                "OS": document.getElementById('os').value || "",
                "OS_Version": document.getElementById('osVersion').value || "",
                "Memory_Size": memStr,
                "Memory_Used": document.getElementById('memUsed').value || "", // String
                "Memory_Available": document.getElementById('memAvail').value || "", // String
                "Bandwidth": bandStr,
                "Description": document.getElementById('description').value || "",
                "Functionality": document.getElementById('functionality').value || "",
                "Sensitivity": document.getElementById('sensitivity').value || "Internal",
                "Backup_Location": document.getElementById('backupLoc').value || ""
            };

            const apiUrl = currentMode === 'create' ? 'http://172.28.192.16/asset/api/insert' : 'http://172.28.192.16/asset/api/update';
            const payload = currentMode === 'create' ? { "assets": [baseData] } : { ...baseData, "id": parseInt(assetId) };

            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Saving...';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === "success") {
                    isDirty = false;
                    alert("Success!");
                    currentMode === 'edit' ? setMode('detail', baseData.Name) : window.location.href = 'index.html';
                }
            } catch (err) {
                alert("Connection failed.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        async function confirmDelete() {
            if (!confirm("Permanently delete?")) return;
            try {
                const response = await fetch('http://172.28.192.16/asset/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ "ids": [parseInt(assetId)] })
                });
                if ((await response.json()).status === "success") {
                    isDirty = false;
                    window.location.href = 'index.html';
                }
            } catch (err) { alert("Delete failed."); }
        }
    </script>
</body>
</html>