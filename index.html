<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Inventory - Dashboard</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Unified Container: Responsive width that scales beautifully */
        .custom-container { max-width: 1600px; margin: 0 auto; width: 95%; overflow: visible; }
        .custom-shadow { box-shadow: 0px 10px 25px rgba(13, 10, 44, 0.04); }
        .table-wrapper { overflow-x: auto; background: white; border-radius: 12px; }

        /* The Fix: Remove fixed 70px height. Use vertical padding instead. */
        tbody tr { cursor: pointer; transition: all 0.2s; }

        /* This gives the "expansive" feel without forcing a huge height on small screens */
        tbody td { padding: 1.25rem 1.25rem !important; }
        .main-content { flex: 1; padding: 1.5rem 0; }

        /* Fluid Typography: The real secret to fixing the "zoom" issue */
        html { font-size: 14px; } /* Default for standard laptops */
        @media (min-width: 1536px) { 
            html { font-size: 15px; } /* Slightly larger for Pro laptops */
        }
        @media (min-width: 1920px) { 
            html { font-size: 16px; } /* Full size for large monitors */
            .custom-container { max-width: 1700px; } 
        }

        /* Dropdown Logic */
        .bg-white.rounded-2xl { overflow: visible; }
        #importDropdown:not(.hidden) { display: block; animation: fadeIn 0.2s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-[#f8fafc]">

    <div class="custom-container main-content">
        <div class="bg-white rounded-2xl p-8 custom-shadow">
            
            <div class="mb-10">
    
                <div class="flex justify-end mb-4">
                    <div class="relative">
                        <button onclick="toggleUserDropdown(event)" 
                            class="flex items-center gap-3 p-1 hover:bg-gray-100 rounded-full transition-all group">
                            <span id="displayUserName" class="text-xs font-bold text-slate-500 hidden sm:block px-1">Admin User</span>
                            <div class="w-10 h-10 bg-white text-slate-400 rounded-full flex items-center justify-center border border-gray-200 group-hover:border-blue-500 group-hover:text-blue-500 transition-all shadow-sm">
                                <i class="fas fa-user-circle text-xl"></i>
                            </div>
                        </button>

                        <div id="userDropdown" class="hidden absolute right-0 mt-2 w-44 bg-white rounded-xl shadow-2xl border border-gray-100 z-[70]">
                            <a href="javascript:void(0)" onclick="handleLogout()" class="flex items-center gap-3 px-4 py-4 text-sm text-red-600 hover:bg-red-50 rounded-xl transition-colors">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="font-bold">Logout</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row justify-between items-center gap-6">
                    
                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <img src="images/FirstbankIcon.png" alt="Logo" class="w-12 h-12 object-contain">
                        <h1 class="text-[#1e293b] text-2xl font-bold tracking-tight">Asset Inventory</h1>
                    </div>
                    
                    <div class="relative w-full lg:max-w-md xl:max-w-xl">
                        <input type="text" id="searchInput" placeholder="Search by name, serial, or category..." 
                            class="w-full pl-6 pr-14 py-3.5 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white text-sm transition-all">
                        <i class="fas fa-search absolute right-6 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>

                    <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto justify-end">
                        <button id="deleteAssetBtn" onclick="deleteSelectedAssets()" class="hidden bg-red-500 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-red-600 shadow-lg shadow-red-100 transition-all">
                            <i class="fas fa-trash-alt"></i> <span>Delete</span>
                        </button>

                        <div class="relative inline-flex">
                            <input type="file" id="importInput" class="hidden" onchange="handleFileImport(event)">
                            <button onclick="document.getElementById('importInput').click()" class="bg-[#10b981] text-white px-5 py-3 rounded-l-xl text-sm font-bold border-r border-green-500/30 hover:bg-green-600 transition-all">
                                <i class="fas fa-file-import"></i> Import
                            </button>
                            <button onclick="toggleImportDropdown(event)" class="bg-[#10b981] text-white px-3 py-3 rounded-r-xl hover:bg-green-600 transition-all">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>

                            <div id="importDropdown" class="hidden absolute right-0 mt-14 w-56 bg-white rounded-xl shadow-2xl border border-gray-100 z-[60]">
                                <div class="p-2 space-y-1">
                                    <button onclick="downloadImportTemplate()" class="w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-all">
                                        <i class="fas fa-download text-blue-500"></i>
                                        <span class="font-semibold">Download Template</span>
                                    </button>
                                    <hr class="border-gray-50 my-1">
                                </div>
                            </div>
                        </div>

                        <button onclick="generateExcelReport(event)" class="bg-[#f59e0b] text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-amber-600 shadow-lg shadow-amber-100 transition-all">
                            <i class="fas fa-file-excel"></i> Report
                        </button>
                        
                        <button onclick="window.location.href='assetdetail.html'" class="bg-[#044BB4] text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-blue-700 shadow-lg shadow-blue-100 transition-all">
                            <i class="fas fa-plus"></i> New Asset
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-wrapper border border-gray-100">
                <table class="w-full text-left border-collapse min-w-[1100px]">
                    <thead>
                        <tr class="bg-gray-50/50 text-[#64748b] text-xs uppercase tracking-widest font-bold border-b border-gray-100">
                            <th class="p-5 w-14 text-center"><input type="checkbox" id="selectAll" class="w-4 h-4 rounded accent-blue-600"></th>
                            <th class="p-5">Asset Name</th>
                            <th class="p-5">Category</th>
                            <th class="p-5">Serial No</th>
                            <th class="p-5">Location</th>
                            <th class="p-5">Department</th>
                            <th onclick="toggleSort('Created_Date')" class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-50 transition-colors">
                                Created Date 
                                <span id="sortIcon"><i class="fas fa-sort ml-1 text-slate-300"></i></span>
                            </th>
                            <th class="p-5 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm text-[#334155] divide-y divide-gray-50">
                        </tbody>
                </table>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-between items-center gap-6 text-sm text-gray-500">
                <div id="footerStatus" class="font-semibold text-gray-500 bg-gray-50 px-4 py-2 rounded-lg">
                    Loading assets...
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1">
                        </div>

                    <div class="flex items-center gap-2 px-3 border-l border-gray-200 ml-2">
                        <span class="text-xs text-gray-400 font-medium">Go to</span>
                        <input type="number" id="jumpPageInput" min="1" 
                            class="w-12 h-10 text-center bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500/20 focus:outline-none"
                            placeholder="#">
                        <button onclick="jumpToPage()" 
                            class="h-10 px-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl text-xs font-bold transition-all">
                            Go
                        </button>
                    </div>

                    <select id="pageSizeSelect" onchange="updatePageSize()" class="ml-2 p-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-semibold text-gray-600 outline-none">
                        <option value="20">20 / Page</option>
                        <option value="50">50 / Page</option>
                        <option value="100">100 / Page</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="py-8 text-center text-gray-400 text-xs font-medium tracking-wide">
        © <script>document.write(new Date().getFullYear());</script> FIRST PENSION CUSTODIAN NIGERIA LIMITED
    </div>

    <script>
        // --- 1. GLOBAL STATE ---
        let allAssets = [];       // Full list from API
        let filteredAssets = [];  // Search/Filter results
        let currentPage = 1;
        let pageSize = 20;
        let sortOrder = 'desc';   // Default to newest first

        // --- 2. INITIALIZATION & AUTH ---
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                loadAssets();
            }
        };

        // --- UPDATED LOGOUT FUNCTION ---
        function handleLogout() {
            // Clear everything so the next user doesn't see old data
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // --- 3. DATA LOADING ---
        async function loadAssets() {
            const tableBody = document.querySelector('tbody');
            const token = localStorage.getItem('token');

            tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin fa-2x mb-3 block mx-auto"></i> Synchronizing Assets...</td></tr>`;

            try {
                const response = await fetch('http://172.28.192.16/asset/api/list_assets', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    allAssets = result.data; 

                    // Default Sort: Newest First
                    allAssets.sort((a, b) => new Date(b.CreatedDate || 0) - new Date(a.CreatedDate || 0));

                    filteredAssets = [...allAssets]; 
                    displayPage(1); 
                } else {
                    tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-red-400">Unable to retrieve data.</td></tr>`;
                }
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-red-400">Network connection failed.</td></tr>`;
            }
        }

        // --- 4. RENDERING & PAGINATION ---
        function displayPage(page) {
            currentPage = page;
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = ''; 

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedItems = filteredAssets.slice(start, end);

            if (paginatedItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-gray-400">No matching assets found.</td></tr>`;
            } else {
                paginatedItems.forEach(asset => {
                    const row = `
                        <tr class="hover:bg-blue-50/40 cursor-pointer transition-all" 
                            ondblclick="window.location.href='assetdetail.html?id=${asset.id}'">
                            <td class="p-5 text-center" onclick="event.stopPropagation()">
                                <input type="checkbox" value="${asset.id}" class="asset-checkbox w-4 h-4 rounded accent-blue-600">
                            </td>
                            <td class="p-5 font-semibold text-slate-700">
                                <a href="assetdetail.html?id=${asset.id}" class="hover:text-blue-600 transition-colors">${asset.Name || 'N/A'}</a>
                            </td>
                            <td class="p-5 text-slate-500">${asset.Category || 'N/A'}</td>
                            <td class="p-5 font-mono text-xs font-bold text-blue-600">${asset.SerialNo || 'N/A'}</td>
                            <td class="p-5 text-slate-500">${asset.Location || 'N/A'}</td>
                            <td class="p-5 text-slate-500">${asset.Department || 'N/A'}</td>
                            <td class="p-5 text-slate-400 text-xs">${asset.CreatedDate || 'N/A'}</td>
                            <td class="p-5 text-center" onclick="event.stopPropagation()">
                                <a href="assetdetail.html?id=${asset.id}&mode=edit" class="inline-block text-blue-500 hover:text-blue-700 p-3 bg-blue-50 rounded-xl transition-all">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            updateFooterStatus(filteredAssets.length === 0 ? 0 : start + 1, Math.min(end, filteredAssets.length), filteredAssets.length);
            renderPaginationControls();
            updateDeleteButtonVisibility();
        }

        function renderPaginationControls() {
            const container = document.querySelector('.flex.items-center.gap-1');
            if (!container) return;

            const totalPages = Math.ceil(filteredAssets.length / pageSize);
            const jumpInput = document.getElementById('jumpPageInput');
            if (jumpInput) jumpInput.max = totalPages;

            let html = '';
            // Previous
            html += `<button onclick="displayPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white disabled:opacity-30 transition-all"><i class="fas fa-chevron-left text-xs"></i></button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const activeClass = i === currentPage ? 'bg-[#044BB4] text-white shadow-lg' : 'border border-gray-200 hover:bg-white';
                    html += `<button onclick="displayPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-xl font-bold transition-all ${activeClass}">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span class="px-1 text-gray-400">...</span>`;
                }
            }

            // Next
            html += `<button onclick="displayPage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white disabled:opacity-30 transition-all"><i class="fas fa-chevron-right text-xs"></i></button>`;

            container.innerHTML = html;
        }

        function jumpToPage() {
            const input = document.getElementById('jumpPageInput');
            const pageNum = parseInt(input.value);
            const totalPages = Math.ceil(filteredAssets.length / pageSize);

            if (pageNum >= 1 && pageNum <= totalPages) {
                displayPage(pageNum);
                input.value = ''; 
            } else {
                alert(`Please enter a page number between 1 and ${totalPages}`);
                input.value = '';
            }
        }

        function updatePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            displayPage(1);
        }

        function updateFooterStatus(start, end, total) {
            const footerStatus = document.getElementById('footerStatus');
            if (!footerStatus) return;
            footerStatus.innerText = total === 0 ? "No assets found" : `Showing ${start} - ${end} of ${total} assets`;
        }

        // --- 5. SEARCH & SORTING ---
        function filterAssets() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toLowerCase();
            const clearBtn = document.getElementById('clearSearch');

            filter.length > 0 ? clearBtn.classList.remove('hidden') : clearBtn.classList.add('hidden');

            filteredAssets = allAssets.filter(asset => {
                const fields = [asset.Name, asset.SerialNo, asset.Category, asset.Location, asset.Department];
                return fields.some(f => (f || '').toLowerCase().includes(filter));
            });

            // Re-apply current sort to filtered results
            applySort();
            displayPage(1);
            
            const selectAll = document.getElementById('selectAll');
            if (selectAll) selectAll.checked = false;
        }

        function toggleSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            const icon = sortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
            document.getElementById('sortIcon').innerHTML = `<i class="fas ${icon} ml-1 text-blue-600"></i>`;
            applySort();
            displayPage(1);
        }

        function applySort() {
            filteredAssets.sort((a, b) => {
                const dateA = new Date(a.CreatedDate || 0);
                const dateB = new Date(b.CreatedDate || 0);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
        }

        // --- 6. DROPDOWN LOGIC ---
        // --- FIX: Updated Dropdown Logic ---
        function toggleImportDropdown(event) {
            event.stopPropagation();
            const importDrop = document.getElementById('importDropdown');
            const userDrop = document.getElementById('userDropdown');
            
            if (userDrop) userDrop.classList.add('hidden'); // Close user menu if open
            importDrop.classList.toggle('hidden');
        }

        function toggleUserDropdown(event) {
            event.stopPropagation();
            const userDrop = document.getElementById('userDropdown');
            const importDrop = document.getElementById('importDropdown');
            
            if (importDrop) importDrop.classList.add('hidden'); // Close import menu if open
            userDrop.classList.toggle('hidden');
        }

        // Global click to close everything
        window.addEventListener('click', (e) => {
            const importDrop = document.getElementById('importDropdown');
            const userDrop = document.getElementById('userDropdown');
            
            if (!e.target.closest('#importDropdown') && !e.target.closest('#userDropdown')) {
                importDrop?.classList.add('hidden');
                userDrop?.classList.add('hidden');
            }
        });

        // --- FIX: Corrected Select All Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    // Find all checkboxes currently in the table body
                    const checkboxes = document.querySelectorAll('tbody .asset-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                    updateDeleteButtonVisibility();
                });
            }

            // Individual checkbox listener (Delegated to the table body)
            const tableBody = document.querySelector('tbody');
            tableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('asset-checkbox')) {
                    updateDeleteButtonVisibility();
                    
                    // Sync the "Select All" checkbox state
                    const allCheckboxes = document.querySelectorAll('tbody .asset-checkbox');
                    const checkedCount = document.querySelectorAll('tbody .asset-checkbox:checked').length;
                    selectAllCheckbox.checked = (checkedCount === allCheckboxes.length && allCheckboxes.length > 0);
                }
            });
        });

        // --- 7. ACTIONS (DELETE, IMPORT, EXPORT) ---
        function updateDeleteButtonVisibility() {
            const deleteBtn = document.getElementById('deleteAssetBtn');
            const checkedBoxes = document.querySelectorAll('.asset-checkbox:checked');
            const count = checkedBoxes.length;

            if (count > 0) {
                deleteBtn.classList.remove('hidden');
                document.getElementById('footerStatus').innerHTML = `<span class="text-blue-600 font-bold"><i class="fas fa-check-circle mr-2"></i>${count} selected</span>`;
            } else {
                deleteBtn.classList.add('hidden');
            }
        }

        async function deleteSelectedAssets() {
            const token = localStorage.getItem('token');
            const ids = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(cb => parseInt(cb.value));

            if (ids.length === 0 || !confirm(`Delete ${ids.length} asset(s)?`)) return;

            const deleteBtn = document.getElementById('deleteAssetBtn');
            deleteBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Deleting...`;

            try {
                const response = await fetch('http://172.28.192.16/asset/api/delete', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "ids": ids })
                });
                if ((await response.json()).status === 'success') {
                    alert('Deleted successfully');
                    loadAssets();
                }
            } catch (e) { alert('Delete failed.'); }
            finally { deleteBtn.innerHTML = `<i class="fas fa-trash-alt mr-2"></i>Delete`; }
        }

        async function generateExcelReport(event) {
            const reportBtn = event.currentTarget;
            const checkedBoxes = document.querySelectorAll('.asset-checkbox:checked');
            const selectedIds = Array.from(checkedBoxes).map(cb => cb.value.toString());

            let dataToExport = selectedIds.length > 0 
                ? allAssets.filter(a => selectedIds.includes(a.id.toString()))
                : allAssets;

            if (selectedIds.length === 0 && !confirm("Export full inventory?")) return;

            reportBtn.disabled = true;
            const originalContent = reportBtn.innerHTML;
            reportBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating...`;

            setTimeout(() => {
                try {
                    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Assets");
                    XLSX.writeFile(workbook, `Asset_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                } finally {
                    reportBtn.disabled = false;
                    reportBtn.innerHTML = originalContent;
                }
            }, 100);
        }

        // --- 8. IMPORT LOGIC ---
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Header Validation
                const required = ["Name", "Category", "SerialNo", "Department", "Location"];
                const firstRow = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                const isValid = required.every(h => firstRow.includes(h));

                if (!isValid) {
                    alert("❌ Incorrect Template! Please use the official template.");
                    return;
                }

                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                if (confirm(`Import ${jsonData.length} assets?`)) {
                    await uploadImportedAssets(jsonData);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function uploadImportedAssets(assets) {
            const token = localStorage.getItem('token');
            const res = await fetch('http://172.28.192.16/asset/api/insert', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ "assets": assets })
            });
            if ((await res.json()).status === 'success') {
                alert('Import Successful!');
                loadAssets();
            }
        }

        function downloadImportTemplate() {
            const data = [{"Name": "Laptop", "Category": "IT", "SerialNo": "SN001", "Department": "HR", "Location": "Main Office"}];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Asset_Import_Template.xlsx");
        }

        // --- 9. EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Fetch data from localStorage
            const userName = localStorage.getItem('user'); // Matches 'user' key from login
            const token = localStorage.getItem('token');

            // 2. Check Authentication - Redirect if not logged in
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // 3. Update the UI with the actual User (e.g., FPC00123)
            const nameDisplay = document.getElementById('displayUserName');
            if (nameDisplay && userName) {
                nameDisplay.textContent = userName;
            }

            // 4. Continue with loading the assets
            loadAssets();

            document.getElementById('searchInput').addEventListener('input', filterAssets);
            document.getElementById('clearSearch').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                filterAssets();
            });

            const jumpInput = document.getElementById('jumpPageInput');
            if (jumpInput) {
                jumpInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') jumpToPage(); });
            }

            document.getElementById('selectAll').addEventListener('change', function() {
                document.querySelectorAll('.asset-checkbox').forEach(cb => cb.checked = this.checked);
                updateDeleteButtonVisibility();
            });

            document.querySelector('tbody').addEventListener('change', (e) => {
                if (e.target.classList.contains('asset-checkbox')) updateDeleteButtonVisibility();
            });
        });
    </script>
    
</body>
</html>