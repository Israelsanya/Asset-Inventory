<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Inventory - Dashboard</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; min-height: 100vh; display: flex; flex-direction: column; }
        /* Increased max-width to 1700px for a more expansive feel like Image 1 */
        .custom-container { max-width: 1700px; margin: 0 auto; width: 100%; }
        .custom-shadow { box-shadow: 0px 10px 25px rgba(13, 10, 44, 0.04); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; background: white; border-radius: 12px; }
        /* Ensuring rows have enough height to prevent the "squished" look */
        tbody tr { min-height: 70px; transition: all 0.2s; }
        .main-content { flex: 1; padding: 2rem; }
        /* Adjust base font size for different resolutions */
        html { font-size: 15px; /* Default */}
        @media (max-width: 1536px) { html { font-size: 13px; } /* Automatically "zooms out" on smaller laptops */}
        @media (min-width: 1920px) { html { font-size: 16px; } /* Keeps it crisp on large monitors */}
        @media (max-width: 1440px) { body { zoom: 0.95; /* This forces a 5% zoom out only on smaller laptop screens */}} 
        /* Ensure the container doesn't feel too stretched on ultrawide screens */
        .custom-container { max-width: 1550px; margin: 0 auto; width: 92%; /* Provides a consistent "margin" on all sides */}
        /* Add a pointer for the rows since they are now clickable */
        tbody tr {cursor: pointer;}
    </style>
</head>
<body class="bg-[#f8fafc]">

    <div class="custom-container main-content">
        <div class="bg-white rounded-2xl p-8 custom-shadow">
            
            <div class="flex flex-col lg:flex-row justify-between items-center mb-10 gap-6">
                <div class="flex items-center gap-4 w-full lg:w-auto relative">
                    <div class="relative group">
                        <img src="images/FirstbankIcon.png" alt="User Menu" id="userMenuBtn"
                            class="w-12 h-12 object-contain cursor-pointer hover:scale-105 transition-transform">
                        
                        <div id="userDropdown" class="hidden absolute left-0 mt-3 w-56 bg-white rounded-xl shadow-2xl border border-gray-100 z-50">
                            <div class="py-2">
                                <div class="px-4 py-3 text-xs text-gray-400 uppercase font-bold tracking-widest">User Options</div>
                                <hr class="border-gray-50">
                                <a href="javascript:void(0)" onclick="handleLogout()" class="flex items-center gap-3 px-4 py-4 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span class="font-semibold">Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <h1 class="text-[#1e293b] text-2xl font-bold tracking-tight">Asset Inventory</h1>
                </div>
                
                <div class="relative w-full lg:max-w-xl">
                    <input type="text" id="searchInput" placeholder="Search by name, serial, or category..." 
                        class="w-full pl-6 pr-14 py-3.5 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white text-sm transition-all">
                    <button id="clearSearch" class="hidden absolute right-14 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times-circle"></i>
                    </button>
                    <i class="fas fa-search absolute right-6 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>

                <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                    <button id="deleteAssetBtn" onclick="deleteSelectedAssets()" class="hidden flex-1 lg:flex-none bg-red-500 text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-red-600 shadow-lg shadow-red-200 transition-all">
                        <i class="fas fa-trash-alt"></i> <span>Delete</span>
                    </button>
                    <button class="flex-1 lg:flex-none bg-[#10b981] text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-green-600 shadow-lg shadow-green-100 transition-all">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                    <button onclick="generateExcelReport(event)" class="flex-1 lg:flex-none bg-[#f59e0b] text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-amber-600 shadow-lg shadow-amber-100 transition-all">
                        <i class="fas fa-file-excel"></i> Report
                    </button>
                    <button onclick="window.location.href='assetdetail.html'" class="flex-1 lg:flex-none bg-[#044BB4] text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                        <i class="fas fa-plus"></i> New Asset
                    </button>
                </div>
            </div>

            <div class="table-wrapper border border-gray-100">
                <table class="w-full text-left border-collapse min-w-[1100px]">
                    <thead>
                        <tr class="bg-gray-50/50 text-[#64748b] text-xs uppercase tracking-widest font-bold border-b border-gray-100">
                            <th class="p-5 w-14 text-center"><input type="checkbox" id="selectAll" class="w-4 h-4 rounded accent-blue-600"></th>
                            <th class="p-5">Asset Name</th>
                            <th class="p-5">Category</th>
                            <th class="p-5">Serial No</th>
                            <th class="p-5">Location</th>
                            <th class="p-5">Department</th>
                            <th class="p-5">Created Date</th>
                            <th class="p-5 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm text-[#334155] divide-y divide-gray-50">
                        </tbody>
                </table>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-between items-center gap-6 text-sm text-gray-500">
                <div id="footerStatus" class="font-semibold text-gray-500 bg-gray-50 px-4 py-2 rounded-lg">
                    Loading assets...
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1">
                        </div>

                    <div class="flex items-center gap-2 px-3 border-l border-gray-200 ml-2">
                        <span class="text-xs text-gray-400 font-medium">Go to</span>
                        <input type="number" id="jumpPageInput" min="1" 
                            class="w-12 h-10 text-center bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500/20 focus:outline-none"
                            placeholder="#">
                        <button onclick="jumpToPage()" 
                            class="h-10 px-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl text-xs font-bold transition-all">
                            Go
                        </button>
                    </div>

                    <select id="pageSizeSelect" onchange="updatePageSize()" class="ml-2 p-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-semibold text-gray-600 outline-none">
                        <option value="20">20 / Page</option>
                        <option value="50">50 / Page</option>
                        <option value="100">100 / Page</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="py-8 text-center text-gray-400 text-xs font-medium tracking-wide">
        Â© <script>document.write(new Date().getFullYear());</script> FIRST PENSION CUSTODIAN NIGERIA LIMITED
    </div>

    <script>
        // Keep your existing script logic exactly as it was
        let totalAssetCount = 0;
        let visibleAssetCount = 0;
        let allAssets = [];       // Will hold the full list from the API
        let filteredAssets = [];  // Will hold search results
        let currentPage = 1;
        let pageSize = 20;

        const menuBtn = document.getElementById('userMenuBtn');
        const dropdown = document.getElementById('userDropdown');

        if (menuBtn) {
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });
        }

        window.addEventListener('click', () => {
            if (dropdown) dropdown.classList.add('hidden');
        });

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        window.onload = function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                loadAssets();
            }
        }

        async function loadAssets() {
            const tableBody = document.querySelector('tbody');
            const token = localStorage.getItem('token');

            tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin fa-2x mb-3 block mx-auto"></i> Synchronizing Assets...</td></tr>`;

            try {
                const response = await fetch('http://172.28.192.16/asset/api/list_assets', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    allAssets = result.data; // Store the full list
                    filteredAssets = [...allAssets]; // Default filtered list is the full list
                    displayPage(1); // Show the first page
                } else {
                    tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-red-400">Unable to retrieve data.</td></tr>`;
                }
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-red-400">Network connection failed.</td></tr>`;
            }
        }

        //*****This is the Display Page and Render Pagination which slice of the array to show based on the page number.
        function displayPage(page) {
            currentPage = page;
            const tableBody = document.querySelector('tbody');
            tableBody.innerHTML = ''; 

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const paginatedItems = filteredAssets.slice(start, end);

            if (paginatedItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-gray-400">No matching assets found.</td></tr>`;
            } else {
                paginatedItems.forEach(asset => {
                    const row = `
                        <tr class="hover:bg-blue-50/40 cursor-pointer transition-all" 
                            ondblclick="window.location.href='assetdetail.html?id=${asset.id}'">
                            <td class="p-5 text-center" ondblclick="event.stopPropagation()">
                                <input type="checkbox" value="${asset.id}" class="asset-checkbox w-4 h-4 rounded accent-blue-600">
                            </td>
                            <td class="p-5 font-semibold text-slate-700">
                                <a href="assetdetail.html?id=${asset.id}" class="hover:text-blue-600 transition-colors">${asset.Name || 'N/A'}</a>
                            </td>
                            <td class="p-5 text-slate-500">${asset.Category || 'N/A'}</td>
                            <td class="p-5 font-mono text-xs font-bold text-blue-600">${asset.SerialNo || 'N/A'}</td>
                            <td class="p-5 text-slate-500">${asset.Location || 'N/A'}</td>
                            <td class="p-5 text-slate-500">${asset.Department || 'N/A'}</td>
                            <td class="p-5 text-slate-400 text-xs">${asset.CreatedDate || 'N/A'}</td>
                            <td class="p-5 text-center" ondblclick="event.stopPropagation()">
                                <a href="assetdetail.html?id=${asset.id}&mode=edit" class="inline-block text-blue-500 hover:text-blue-700 p-3 bg-blue-50 rounded-xl transition-all">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            updateFooterStatus(filteredAssets.length === 0 ? 0 : start + 1, Math.min(end, filteredAssets.length), filteredAssets.length);
            renderPaginationControls();
            updateDeleteButtonVisibility(); // Ensure delete button hides/shows correctly on page change
        }

        function updateFooterStatus(start, end, total) {
            const footerStatus = document.getElementById('footerStatus');
            if (total === 0) {
                footerStatus.innerText = "No assets found";
            } else {
                footerStatus.innerText = `Showing ${start} - ${end} of ${total} assets`;
            }
        }

        function renderPaginationControls() {
            const container = document.querySelector('.flex.items-center.gap-1');
            const totalPages = Math.ceil(filteredAssets.length / pageSize);
            const jumpInput = document.getElementById('jumpPageInput');
            if (jumpInput) jumpInput.max = totalPages;
            let html = '';

            // Previous Button
            html += `<button onclick="displayPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white disabled:opacity-30 transition-all"><i class="fas fa-chevron-left text-xs"></i></button>`;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const activeClass = i === currentPage ? 'bg-[#044BB4] text-white shadow-lg shadow-blue-100' : 'border border-gray-200 hover:bg-white';
                    html += `<button onclick="displayPage(${i})" class="w-10 h-10 flex items-center justify-center rounded-xl font-bold transition-all ${activeClass}">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span class="px-1 text-gray-400">...</span>`;
                }
            }

            // Next Button
            html += `<button onclick="displayPage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white disabled:opacity-30 transition-all"><i class="fas fa-chevron-right text-xs"></i></button>`;

            container.innerHTML = html;
        }

        function updateDeleteButtonVisibility() {
            const tableBody = document.querySelector('tbody');
            const deleteBtn = document.getElementById('deleteAssetBtn');
            const footerStatus = document.getElementById('footerStatus');
            
            // Count checked boxes on the current page
            const checkedBoxes = Array.from(tableBody.querySelectorAll('.asset-checkbox:checked'));
            const count = checkedBoxes.length;

            if (count > 0) {
                deleteBtn.classList.remove('hidden');
                footerStatus.innerHTML = `<span class="text-blue-600 font-bold"><i class="fas fa-check-circle mr-2"></i>${count} asset${count > 1 ? 's' : ''} selected</span>`;
            } else {
                deleteBtn.classList.add('hidden');
                // Call updateFooterStatus to restore the "Showing X - Y of Z" text
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                updateFooterStatus(filteredAssets.length === 0 ? 0 : start + 1, Math.min(end, filteredAssets.length), filteredAssets.length);
            }
        }

        function filterAssets() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toLowerCase();
            const clearBtn = document.getElementById('clearSearch');

            if (filter.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            filteredAssets = allAssets.filter(asset => {
                const name = (asset.Name || '').toLowerCase();
                const serial = (asset.SerialNo || '').toLowerCase();
                const category = (asset.Category || '').toLowerCase();
                const location = (asset.Location || '').toLowerCase();
                const dept = (asset.Department || '').toLowerCase();

                return name.includes(filter) || serial.includes(filter) || category.includes(filter) || 
                       location.includes(filter) || dept.includes(filter);
            });

            displayPage(1);
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
        }

        // ONE unified listener for all setup
        document.addEventListener('DOMContentLoaded', () => {
            // Search logic
            document.getElementById('searchInput').addEventListener('input', filterAssets);
            document.getElementById('clearSearch').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                filterAssets();
            });

            // "Jump to" logic
            const jumpInput = document.getElementById('jumpPageInput');
            if (jumpInput) {
                jumpInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') jumpToPage();
                });
            }

            // Selection logic
            document.getElementById('selectAll').addEventListener('change', function() {
                document.querySelectorAll('.asset-checkbox').forEach(cb => {
                    cb.checked = this.checked;
                });
                updateDeleteButtonVisibility();
            });

            document.querySelector('tbody').addEventListener('change', (e) => {
                if (e.target.classList.contains('asset-checkbox')) {
                    updateDeleteButtonVisibility();
                }
            });
        });

        function jumpToPage() {
            const input = document.getElementById('jumpPageInput');
            const pageNum = parseInt(input.value);
            const totalPages = Math.ceil(filteredAssets.length / pageSize);

            if (pageNum >= 1 && pageNum <= totalPages) {
                displayPage(pageNum);
                input.value = ''; 
            } else {
                alert(`Please enter a page number between 1 and ${totalPages}`);
                input.value = '';
            }
        }

        //**** DELETE FUNCTION ****//
        async function deleteSelectedAssets() {
            const tableBody = document.querySelector('tbody');
            const token = localStorage.getItem('token');
            const checkedBoxes = Array.from(tableBody.querySelectorAll('.asset-checkbox:checked'));
            const idsToDelete = checkedBoxes.map(cb => parseInt(cb.value));

            if (idsToDelete.length === 0) return;
            if (!confirm(`Permanently delete ${idsToDelete.length} asset(s)?`)) return;

            try {
                const deleteBtn = document.getElementById('deleteAssetBtn');
                deleteBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Deleting...`;
                deleteBtn.disabled = true;

                const response = await fetch('http://172.28.192.16/asset/api/delete', {
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "ids": idsToDelete })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert('Deleted successfully');
                    document.getElementById('selectAll').checked = false;
                    loadAssets(); 
                } else {
                    alert('Error: ' + result.message);
                    displayPage(currentPage); // Refresh current view
                }
            } catch (error) {
                alert('Connection error.');
                displayPage(currentPage);
            }
        }

        function updatePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            displayPage(1);
        }

        //**** EXCEL REPORT GENERATION ****//
        async function generateExcelReport() {
            const reportBtn = event.currentTarget; // Captures the button clicked
            const originalContent = reportBtn.innerHTML;
            const tableBody = document.querySelector('tbody');
            
            // 1. Selection Logic
            const checkedBoxes = Array.from(tableBody.querySelectorAll('.asset-checkbox:checked'));
            const selectedIds = checkedBoxes.map(cb => cb.value.toString());

            let dataToExport = [];
            if (selectedIds.length > 0) {
                dataToExport = allAssets.filter(asset => selectedIds.includes(asset.id.toString()));
            } else {
                const confirmAll = confirm("No assets selected. Export the FULL inventory?");
                if (!confirmAll) return;
                dataToExport = allAssets; // Export everything in the master list
            }

            // 2. Show Loading State
            reportBtn.disabled = true;
            reportBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating...`;

            // 3. Process Excel (Wrapped in setTimeout so the spinner actually shows up)
            setTimeout(() => {
                try {
                    const excelRows = dataToExport.map(asset => ({
                        "Asset ID": asset.id || '',
                        "Asset Name": asset.Name || '',
                        "Category": asset.Category || '',
                        "Brand": asset.Brand || '',
                        "Model": asset.Model || '',
                        "Serial Number": asset.SerialNo || '',
                        "Department": asset.Department || '',
                        "Location": asset.Location || '',
                        "Staff Name": asset.StaffName || '',
                        "Staff ID": asset.StaffID || '',
                        "Operating System": asset.OS || '',
                        "OS Version": asset.OS_Version || '',
                        "IP Address": asset.IP_Address || '',
                        "Functionality": asset.Functionality || '',
                        "Sensitivity": asset.Sensitivity || '',
                        "Memory Total (MB)": asset.Memory_Size || '',
                        "Memory Used (MB)": asset.Memory_Used || '',
                        "Memory Available (MB)": asset.Memory_Available || '',
                        "Bandwidth": asset.Bandwidth || '',
                        "Backup Location": asset.Backup_Location || '',
                        "Description": asset.Description || ''
                    }));

                    const worksheet = XLSX.utils.json_to_sheet(excelRows);
                    
                    // Auto-size columns
                    const wscols = Object.keys(excelRows[0] || {}).map(key => ({ wch: key.length + 15 }));
                    worksheet['!cols'] = wscols;

                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Full Asset Report");

                    const date = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(workbook, `Asset_Inventory_Detailed_${date}.xlsx`);

                } catch (error) {
                    console.error("Excel Error:", error);
                    alert("Failed to generate report.");
                } finally {
                    // 4. Restore Button State
                    reportBtn.disabled = false;
                    reportBtn.innerHTML = originalContent;
                }
            }, 100); // 100ms delay is enough for the UI to update
        }
        
        function editAsset(id) { 
            console.log("Editing Asset ID:", id); 
        }
    </script>
</body>
</html>