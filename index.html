<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Inventory - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; min-height: 100vh; display: flex; flex-direction: column; }
        /* Increased max-width to 1700px for a more expansive feel like Image 1 */
        .custom-container { max-width: 1700px; margin: 0 auto; width: 100%; }
        .custom-shadow { box-shadow: 0px 10px 25px rgba(13, 10, 44, 0.04); }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; background: white; border-radius: 12px; }
        /* Ensuring rows have enough height to prevent the "squished" look */
        tbody tr { min-height: 70px; transition: all 0.2s; }
        .main-content { flex: 1; padding: 2rem; }
    </style>
</head>
<body class="bg-[#f8fafc]">

    <div class="custom-container main-content">
        <div class="bg-white rounded-2xl p-8 custom-shadow">
            
            <div class="flex flex-col lg:flex-row justify-between items-center mb-10 gap-6">
                <div class="flex items-center gap-4 w-full lg:w-auto relative">
                    <div class="relative group">
                        <img src="images/FirstbankIcon.png" alt="User Menu" id="userMenuBtn"
                            class="w-12 h-12 object-contain cursor-pointer hover:scale-105 transition-transform">
                        
                        <div id="userDropdown" class="hidden absolute left-0 mt-3 w-56 bg-white rounded-xl shadow-2xl border border-gray-100 z-50">
                            <div class="py-2">
                                <div class="px-4 py-3 text-xs text-gray-400 uppercase font-bold tracking-widest">User Options</div>
                                <hr class="border-gray-50">
                                <a href="javascript:void(0)" onclick="handleLogout()" class="flex items-center gap-3 px-4 py-4 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span class="font-semibold">Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <h1 class="text-[#1e293b] text-2xl font-bold tracking-tight">Asset Inventory</h1>
                </div>
                
                <div class="relative w-full lg:max-w-xl">
                    <input type="text" id="searchInput" placeholder="Search by name, serial, or category..." 
                        class="w-full pl-6 pr-14 py-3.5 bg-gray-50 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white text-sm transition-all">
                    <button id="clearSearch" class="hidden absolute right-14 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times-circle"></i>
                    </button>
                    <i class="fas fa-search absolute right-6 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>

                <div class="flex flex-wrap items-center gap-3 w-full lg:w-auto">
                    <button id="deleteAssetBtn" onclick="deleteSelectedAssets()" class="hidden flex-1 lg:flex-none bg-red-500 text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-red-600 shadow-lg shadow-red-200 transition-all">
                        <i class="fas fa-trash-alt"></i> <span>Delete</span>
                    </button>
                    <button class="flex-1 lg:flex-none bg-[#10b981] text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-green-600 shadow-lg shadow-green-100 transition-all">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                    <button class="flex-1 lg:flex-none bg-[#f59e0b] text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-amber-600 shadow-lg shadow-amber-100 transition-all">
                        <i class="fas fa-file-excel"></i> Report
                    </button>
                    <button onclick="window.location.href='add_asset.html'" class="flex-1 lg:flex-none bg-[#044BB4] text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                        <i class="fas fa-plus"></i> New Asset
                    </button>
                </div>
            </div>

            <div class="table-wrapper border border-gray-100">
                <table class="w-full text-left border-collapse min-w-[1100px]">
                    <thead>
                        <tr class="bg-gray-50/50 text-[#64748b] text-xs uppercase tracking-widest font-bold border-b border-gray-100">
                            <th class="p-5 w-14 text-center"><input type="checkbox" id="selectAll" class="w-4 h-4 rounded accent-blue-600"></th>
                            <th class="p-5">Asset Name</th>
                            <th class="p-5">Category</th>
                            <th class="p-5">Serial No</th>
                            <th class="p-5">Location</th>
                            <th class="p-5">Department</th>
                            <th class="p-5">Created Date</th>
                            <th class="p-5 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm text-[#334155] divide-y divide-gray-50">
                        </tbody>
                </table>
            </div>

            <div class="mt-10 flex flex-col sm:flex-row justify-between items-center gap-6 text-sm text-gray-500">
                <div id="footerStatus" class="font-semibold text-gray-500 bg-gray-50 px-4 py-2 rounded-lg">
                    Loading assets...
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1">
                        <button class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white hover:shadow-sm transition-all"><i class="fas fa-chevron-left text-xs"></i></button>
                        <button class="w-10 h-10 flex items-center justify-center bg-[#044BB4] text-white rounded-xl font-bold shadow-lg shadow-blue-100">1</button>
                        <button class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white hover:shadow-sm transition-all">2</button>
                        <button class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white hover:shadow-sm transition-all">3</button>
                        <button class="w-10 h-10 flex items-center justify-center border border-gray-200 rounded-xl hover:bg-white hover:shadow-sm transition-all"><i class="fas fa-chevron-right text-xs"></i></button>
                    </div>
                    
                    <select class="ml-4 p-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/10 font-medium">
                        <option>20 / Page</option>
                        <option>50 / Page</option>
                        <option>100 / Page</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="py-8 text-center text-gray-400 text-xs font-medium tracking-wide">
        Â© <script>document.write(new Date().getFullYear());</script> FIRST PENSION CUSTODIAN NIGERIA LIMITED
    </div>

    <script>
        // Keep your existing script logic exactly as it was
        let totalAssetCount = 0;
        let visibleAssetCount = 0;

        const menuBtn = document.getElementById('userMenuBtn');
        const dropdown = document.getElementById('userDropdown');

        if (menuBtn) {
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });
        }

        window.addEventListener('click', () => {
            if (dropdown) dropdown.classList.add('hidden');
        });

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        window.onload = function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                loadAssets();
            }
        }

        async function loadAssets() {
            const tableBody = document.querySelector('tbody');
            const footerStatus = document.getElementById('footerStatus');
            const token = localStorage.getItem('token');

            tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-gray-400"><i class="fas fa-circle-notch fa-spin fa-2x mb-3 block mx-auto"></i> Synchronizing Assets...</td></tr>`;

            try {
                const response = await fetch('http://172.28.192.16/asset/api/list_assets', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    tableBody.innerHTML = ''; 
                    totalAssetCount = result.count || result.data.length;
                    visibleAssetCount = result.data.length;

                    result.data.forEach(asset => {
                        const row = `
                            <tr class="hover:bg-blue-50/40">
                                <td class="p-5 text-center"><input type="checkbox" value="${asset.id}" class="w-4 h-4 rounded accent-blue-600"></td>
                                <td class="p-5 font-semibold text-slate-700">${asset.Name || 'N/A'}</td>
                                <td class="p-5 text-slate-500">${asset.Category || 'N/A'}</td>
                                <td class="p-5 font-mono text-xs font-bold text-blue-600">${asset.SerialNo || 'N/A'}</td>
                                <td class="p-5 text-slate-500">${asset.Location || 'N/A'}</td>
                                <td class="p-5 text-slate-500">${asset.Department || 'N/A'}</td>
                                <td class="p-5">
                                    <span class="text-xs font-bold text-slate-400 block uppercase">Recently Added</span>
                                    <span class="text-[10px] text-blue-400">#${asset.id}</span>
                                </td>
                                <td class="p-5 text-center">
                                    <button onclick="editAsset('${asset.id}')" class="text-blue-500 hover:text-blue-700 p-3 bg-blue-50 rounded-xl transition-all">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>`;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });

                    footerStatus.innerText = `Showing 1 - ${visibleAssetCount} of ${totalAssetCount} total assets`;
                } else {
                    tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-red-400">Unable to retrieve data.</td></tr>`;
                }
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="8" class="p-20 text-center text-red-400">Network connection failed.</td></tr>`;
            }
        }

        function updateDeleteButtonVisibility() {
            const tableBody = document.querySelector('tbody');
            const deleteBtn = document.getElementById('deleteAssetBtn');
            const footerStatus = document.getElementById('footerStatus');
            const checkedBoxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"]:checked')).filter(cb => cb.closest('tr').style.display !== 'none');
            const count = checkedBoxes.length;

            if (count > 0) {
                deleteBtn.classList.remove('hidden');
                footerStatus.innerHTML = `<span class="text-blue-600 font-bold"><i class="fas fa-check-circle mr-2"></i>${count} asset${count > 1 ? 's' : ''} selected</span>`;
            } else {
                deleteBtn.classList.add('hidden');
                footerStatus.innerText = `Showing 1 - ${visibleAssetCount} of ${totalAssetCount} total assets`;
            }
        }

        // ... rest of your search and selection event listeners remain the same ...
        function filterAssets() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toLowerCase();
            const tableRows = document.querySelectorAll('tbody tr');
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            tableRows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
            updateDeleteButtonVisibility();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('input', filterAssets);
            document.getElementById('selectAll').addEventListener('change', function() {
                document.querySelectorAll('tbody input[type="checkbox"]').forEach(cb => {
                    if (cb.closest('tr').style.display !== 'none') cb.checked = this.checked;
                });
                updateDeleteButtonVisibility();
            });
            document.querySelector('tbody').addEventListener('change', updateDeleteButtonVisibility);
        });

        //******* Delete function ******
        async function deleteSelectedAssets() {
            const tableBody = document.querySelector('tbody');
            const token = localStorage.getItem('token');
            
            // 1. Map checkboxes to an array of integers as required by API
            const checkedBoxes = Array.from(tableBody.querySelectorAll('input[type="checkbox"]:checked'));
            const idsToDelete = checkedBoxes.map(cb => parseInt(cb.value));

            if (idsToDelete.length === 0) return;

            // 2. Safety Confirmation
            if (!confirm(`Are you sure you want to permanently delete ${idsToDelete.length} asset(s)?`)) return;

            try {
                // 3. Update Button UI
                const deleteBtn = document.getElementById('deleteAssetBtn');
                const originalContent = deleteBtn.innerHTML;
                deleteBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;
                deleteBtn.disabled = true;

                // 4. API Request
                const response = await fetch('http://172.28.192.16/asset/api/delete', {
                    method: 'POST', 
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "ids": idsToDelete }) // Matches documentation format
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Success feedback
                    alert(`Success: ${result.message}`); 
                    
                    // 5. Refresh the UI
                    document.getElementById('selectAll').checked = false;
                    loadAssets(); // Reloads the table to show updated list
                } else {
                    alert('Error: ' + (result.message || 'Could not delete assets'));
                    deleteBtn.innerHTML = originalContent;
                    deleteBtn.disabled = false;
                }
            } catch (error) {
                console.error('Delete Error:', error);
                alert('Connection error. Please check if the server is reachable.');
                loadAssets(); // Reset table view
            }
        }
        function editAsset(id) { 
            console.log("Editing Asset ID:", id); 
        }
    </script>
</body>
</html>